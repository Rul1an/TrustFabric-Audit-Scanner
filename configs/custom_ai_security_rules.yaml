# Custom Semgrep Rules for AI/Medical Security
# TrustFabric-specific patterns

rules:
  # ============================================================================
  # PHI SAFETY (CRITICAL for Medical AI)
  # ============================================================================

  - id: phi-in-logging
    pattern-either:
      - pattern: logger.$METHOD(f"... {patient_name} ...")
      - pattern: logger.$METHOD(f"... {patient_id} ...")
      - pattern: logger.$METHOD(f"... {ssn} ...")
      - pattern: logger.$METHOD(f"... {mrn} ...")
      - pattern: logger.$METHOD(f"... {medical_record_number} ...")
      - pattern: logger.$METHOD(f"... {dob} ...")
      - pattern: logger.$METHOD(f"... {date_of_birth} ...")
      - pattern: print(f"... {patient_name} ...")
      - pattern: print(f"... {patient_id} ...")
    message: "PHI detected in log statement. Use hash instead: logger.info(f'Patient hash: {hashlib.sha256(patient_id.encode()).hexdigest()}')"
    severity: ERROR
    languages: [python]
    paths:
      exclude:
        - "*/tests/*"
        - "*/test_*.py"
        - "**/examples/*"
        - "**/client/*"
    metadata:
      category: security
      cwe: "CWE-532: Insertion of Sensitive Information into Log File"
      impact: CRITICAL
      likelihood: HIGH
      confidence: HIGH

  - id: phi-in-evidence-pack
    pattern: |
      evidence_pack = {
        ...
        "inference": {
          ...
          "input": $RAW_DATA,
          ...
        }
      }
    message: "Raw input data in Evidence Pack. Use input_hash instead (PHI safety)."
    severity: ERROR
    languages: [python]
    metadata:
      impact: CRITICAL

  # ============================================================================
  # CRYPTOGRAPHIC VULNERABILITIES
  # ============================================================================

  - id: weak-hash-algorithm
    pattern-either:
      - pattern: hashlib.md5(...)
      - pattern: hashlib.sha1(...)
    message: "Weak hash algorithm. Use SHA256 or stronger."
    severity: WARNING
    languages: [python]
    metadata:
      cwe: "CWE-327: Use of a Broken or Risky Cryptographic Algorithm"

  - id: hardcoded-cryptographic-key
    pattern-either:
      - pattern: private_key = "..."
      - pattern: secret_key = "..."
      - pattern: signing_key = "..."
    message: "Hardcoded cryptographic key. Use Key Vault or environment variable."
    severity: ERROR
    languages: [python]
    metadata:
      cwe: "CWE-798: Use of Hard-coded Credentials"
      impact: CRITICAL

  - id: insecure-random
    pattern-either:
      - pattern: random.random()
      - pattern: random.randint(...)
    message: "Insecure random number generator. Use secrets.token_bytes() for crypto."
    severity: WARNING
    languages: [python]
    metadata:
      cwe: "CWE-338: Use of Cryptographically Weak PRNG"

  # ============================================================================
  # ATTESTATION SECURITY
  # ============================================================================

  - id: attestation-bypass
    pattern-either:
      - pattern: |
          if SKIP_ATTESTATION:
            return $RESULT
      - pattern: |
          if not REQUIRE_ATTESTATION:
            ...
    message: "Attestation bypass detected. This defeats security guarantee."
    severity: ERROR
    languages: [python]
    paths:
      exclude:
        - "*/tests/*"
        - "*/demo_*.py"
    metadata:
      impact: CRITICAL

  - id: missing-nonce-validation
    pattern: |
      def attest_sevsnp($QUOTE):
        ...
    message: "Attestation without nonce validation. Add nonce parameter for replay protection."
    severity: WARNING
    languages: [python]

  # ============================================================================
  # INPUT VALIDATION
  # ============================================================================

  - id: sql-injection-risk
    pattern-either:
      - pattern: cursor.execute(f"SELECT * FROM {$TABLE} WHERE ...")
      - pattern: cursor.execute("SELECT * FROM " + $TABLE + " WHERE ...")
    message: "SQL injection risk. Use parameterized queries."
    severity: ERROR
    languages: [python]
    metadata:
      cwe: "CWE-89: SQL Injection"
      owasp: "A03:2021 - Injection"

  - id: command-injection-risk
    pattern-either:
      - pattern: subprocess.run(f"{$CMD} {$INPUT}", shell=True)
      - pattern: os.system($USER_INPUT)
    message: "Command injection risk. Avoid shell=True with user input."
    severity: ERROR
    languages: [python]
    metadata:
      cwe: "CWE-78: OS Command Injection"
      owasp: "A03:2021 - Injection"

  # ============================================================================
  # AI/ML SPECIFIC
  # ============================================================================

  - id: model-loading-without-verification
    pattern: |
      model = torch.load($PATH)
    message: "Model loaded without hash verification. Validate model integrity first."
    severity: WARNING
    languages: [python]
    metadata:
      owasp-llm: "LLM01: Model Poisoning"

  - id: excessive-error-details
    pattern: |
      except $EXCEPTION as e:
        ...
        return ..., str(e), ...
    message: "Exception details in response may leak sensitive information."
    severity: WARNING
    languages: [python]
    metadata:
      cwe: "CWE-209: Generation of Error Message Containing Sensitive Information"

